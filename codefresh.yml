version: '1.0'
steps:
    start_clean:
        title: Clean up CodeFresh volume
        # Images come from hierarchy at: https://github.com/docker-library/python
        image: python:3.6-buster
        commands:
            - rm -rf leafbuild '${{CF_REPO_NAME}}' venv

    clone_leafbuild_repo:
        type: git-clone
        title: Clone leafbuild repo
        description: Clone the leafbuild repository to pick up Dockerfile \
                     and any other build stuff common between repos.
        repo: leaf-ai/leafbuild
        git: github
        revision: master

    clone_leaf-common:
        type: git-clone
        title: Clone leaf-common
        repo: '${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}'
        revision: '${{CF_REVISION}}'
        git: github

    install_dependencies_and_setup:
        title: Install dependencies and setup security
        image: python:3.6-buster
        description: >-
            1. Setup environment for artifactory and AWS.
            2. Create a virtualenv inside the CodeFresh workspace
               so that it is transferable between freestyle steps.
            3. Install python dependencies
        commands:
            - bash leafbuild/scripts/setup_artifactory.sh
            - bash leafbuild/scripts/setup_aws.sh
            - export VENV=./venv/codefresh
            - mkdir -p $VENV
            - pip install pip==20.0.2
            - pip install virtualenv==20.0.23
            - export VENV_CMD=`which virtualenv`
            - $VENV_CMD $VENV
            - export PATH="$PWD/$VENV/bin:$PATH"
            - $VENV/bin/activate
            - pip install pip==20.0.2
            - pip install virtualenv==20.0.23
            - cd '${{CF_REPO_NAME}}'
            - git status
            - pip --no-cache-dir install -r requirements.txt
            - pip -V
            - export PYTHONPATH=$PWD

    flake8:
        title: Run static flake8 checks
        image: python:3.6-buster
        description: Run Flake8
        commands:
            - export VENV=./venv/codefresh
            - export PATH="$PWD/$VENV/bin:$PATH"
            - echo "PATH=$PATH"
            - cd '${{CF_REPO_NAME}}'
            - git status
            - export PYTHONPATH=$PWD
            - echo "PYTHONPATH=$PYTHONPATH"
            - $VENV/bin/activate
            - export FLAKE8_CMD=`which flake8`
            - echo "FLAKE8_CMD=$FLAKE8_CMD"
            - $FLAKE8_CMD .

    pylint:
        title: Run static pylint checks
        image: python:3.6-buster
        description: Run Pylint
        commands:
            - export VENV=./venv/codefresh
            - export PATH="$PWD/$VENV/bin:$PATH"
            - echo "PATH=$PATH"
            - cd '${{CF_REPO_NAME}}'
            - git status
            - export PYTHONPATH=$PWD
            - echo "PYTHONPATH=$PYTHONPATH"
            - $VENV/bin/activate
            - export PYLINT_CMD=`which pylint`
            - echo "PYLINT_CMD=$PYLINT_CMD"
            - $PYLINT_CMD $(find . -name \*.py | xargs)

    tests:
        title: Run unit tests
        image: python:3.6-buster
        description: Run unit tests (nosetests)
        commands:
            - export VENV=./venv/codefresh
            - export PATH="$PWD/$VENV/bin:$PATH"
            - mkdir -p $HOME/.enn
            - cd '${{CF_REPO_NAME}}'
            - git status
            - export PYTHONPATH=$PWD
            - echo "PYTHONPATH=$PYTHONPATH"
            - $VENV/bin/activate
            - export NOSETESTS_CMD=`which nosetests`
            - echo "NOSETESTS=$NOSETESTS_CMD"
            - $NOSETESTS_CMD -v --with-ignore-docstrings .

    end_clean:
        title: Clean up CodeFresh volume
        image: python:3.6-buster
        commands:
            - rm -rf leafbuild '${{CF_REPO_NAME}}' venv
